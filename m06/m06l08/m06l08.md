# Занятие 8: Captcha. Способы решения Captcha и Cloudflare

## Введение

**Captcha** — это система проверки, предназначенная для различения людей и автоматических программ (ботов). Она помогает предотвратить нежелательную активность, такую как спам или атаки с использованием ботов, и применяется на многих сайтах для защиты от автоматизированных действий.

### Виды Captcha:
1. **Текстовая Captcha** (например, Google reCAPTCHA v2) — пользователю нужно ввести символы, изображенные на искаженной картинке, чтобы доказать, что он человек.
![alt text](image-3.png)  
![alt text](image-4.png)
2. **Изображения** (например, Google reCAPTCHA v3) — пользователю предлагается выбрать изображения, которые соответствуют определенному критерию (например, «выберите все изображения с велосипедами»).
![alt text](image.png)  
Иногда можно встретить подобные капчи, как на изображении ниже, где необходимо вставить пазл в указанное место. Такие задачи сложны для решения программным кодом, но не вызывают трудностей у человека. 
![alt text](image-2.png)

3. **reCAPTCHA v3** — более современная версия, которая не требует действий от пользователя. Она оценивает поведение пользователя на сайте (например, клики, движения мыши) и присваивает ему оценку риска.
4. **Биометрические методы** — использование сканирования отпечатков пальцев или распознавания лиц.

### Что такое **Cloudflare**?
**Cloudflare** — это сервис защиты и оптимизации веб-сайтов, предоставляющий решения для защиты от DDoS-атак, ускорения загрузки сайтов и безопасности веб-приложений. Он включает в себя **WAF (Web Application Firewall)** и различные инструменты для защиты от автоматизированных атак и спама, таких как **Bot Management**.

### Взаимодействие Captcha и Cloudflare:
Cloudflare активно использует системы защиты, такие как **Captcha** и **JavaScript-ориентированные решения** (например, **"I'm Under Attack"** режим), чтобы остановить ботов и автоматические атаки. Когда Cloudflare обнаруживает подозрительное поведение (например, высокую частоту запросов с одного IP-адреса или странный трафик), он может запросить решение Captcha от посетителя.

- **Как это работает**: Когда посетитель сайта проходит через Cloudflare, сервер Cloudflare может запросить у него решение Captcha, если система обнаруживает, что запрос может исходить от бота. В таких случаях пользователю нужно решить Captcha, чтобы пройти дальше.
  
- **Cloudflare и reCAPTCHA**: Cloudflare использует **Google reCAPTCHA** для защиты своих клиентов от ботов. В некоторых случаях, если Cloudflare подозревает, что трафик может быть ботом, он может применить Captcha или запросить от пользователя дополнительную проверку (например, на проверку IP-адреса).
![alt text](image-1.png)


## Этичность

Обход капчи **является неэтичным и незаконным действием**. Капча, также известная как "Completely Automated Public Turing test to tell Computers and Humans Apart", предназначена для отличения людей от ботов и защиты веб-сайтов от автоматического спама и взлома. Обход капчи позволяет ботам проходить тест и выполнять нежелательные действия на веб-сайте.

**Законодательство** многих стран запрещает обход капчи и наказывает за это.   
Например, в России обход капчи расценивается как **нарушение закона "О защите информации"** и может повлечь наказание в виде штрафа или даже уголовного дела.  

При использовании капчи для ознакомительных целей, рекомендуется получить согласие создателя веб-сайта или сервиса, использующего капчу. В противном случае, может быть нарушено законодательство о защите информации и нарушены авторские права создателя. Также, необходимо следить за правилами использования капчи, которые указаны на сайте или сервисе, и не использовать ее для нежелательных действий, таких как спам или атаки.

Использование полученных знаний в целях, не соответствующих целям курса, может привести к серьезным наказаниям, включая штрафы или уголовное дело. Необходимо следовать законодательству и принимать меры по защите информации и авторских прав. Используйте эти знания только для ознакомительных целей и в соответствии с рекомендациями автора курса. 

Автор курса не несёт ответственности за вред причинённый с помощью информации в этом разделе курса, и призывает всех учеников к осторожности и соблюдению законодательства при использовании информации, полученной в этом разделе курса.

## Когда показывается капча

В Интернете существует огромное количество способов вести себя плохо, если вы программист. Вам может прийти в голову зарегистрировать 10 000 аккаунтов на вашем любимом сайте и устроить вакханалию, или вы можете захотеть написать безобидный скрипт для сбора информации с сайта. В первом и втором случае вы можете столкнуться с капчей, которая создается для того, чтобы усложнить задачу новичку-программисту или совсем помешать его планам. 

Капчи создаются программистами для защиты от других программистов. Можно представить это как белую и черную сторону печеньки: одни защищают, другие обходят эту защиту. Между разработчиками капч и разработчиками скриптов идет борьба, и пока что побеждают разработчики скриптов, по той причине, что практически любую капчу можно обойти автоматически.

**Самый сложный вид капчи** для решения - это тот, который связан с отправкой кода на номер телефона. Практически нерешаемой капчей считается та, когда приходит звонок на ваш номер телефона и произносится секретный код.  
Такие капчи не могут быть решены без дополнительного программного обеспечения. Однако, если у вас есть время, вы можете смело повышать цену за решение таких задач на фрилансе. 

Любая капча может быть привязана к любому событию на сайте, основных событий не так много, ниже я их перечислю:
1. При регистрации аккаунта;
2. При нажатии на запрограммированную кнопку или при посещении страницы;
3. Каждые N-запросов;
4. Каждые N времени, например, каждые 10-30 минут, хоть это не частая практика, но такое иногда бывает;
5. В любом другом случае, когда система безопасности сайта заподозрила в ваших действиях автоматизацию;


## Решение Капч

### Способы решения Captcha:
1. **Автоматизированное решение**:
   - Использование ботов или скриптов, которые пытаются "обмануть" систему, например, через оптическое распознавание символов или автоматическое распознавание изображений.
   - Это может быть сделано с помощью машинного обучения или алгоритмов распознавания изображений, однако современные системы Captcha, такие как Google reCAPTCHA v3, значительно усложнили этот процесс.

2. **Решение людьми**:
   - Некоторые сервисы предлагают возможность решения Captcha с помощью реальных людей. Программные решения, такие как 2Captcha или Anti-Captcha, предоставляют API, которые направляют изображение Captcha реальному человеку, который вводит правильный ответ.
   - Это может быть дорогим вариантом, но это работает эффективно, особенно против сложных типов Captcha, таких как reCAPTCHA.

3. **Использование браузерных расширений**:
   - Для личного использования существуют расширения и плагины для браузеров, которые помогают автоматизировать решение Captcha, но они могут быть опасны для безопасности данных.

### Обход Captcha на Cloudflare:
1. **Использование прокси и VPN**:
   - Один из способов обхода Captcha — это использование прокси-серверов или VPN для смены IP-адреса, чтобы избежать блокировок по географическому положению или частоте запросов.
   
2. **Использование сервисов решения Captcha**:
   - Некоторые пользователи обходят Cloudflare Captcha, используя сторонние сервисы, такие как **2Captcha** или **Anti-Captcha**, где реальный человек решает Captcha для автоматизированных систем.

3. **Машинное обучение**:
   - Для более сложных систем, таких как **reCAPTCHA v3**, некоторые разрабатывают алгоритмы машинного обучения, которые пытаются имитировать поведение человека на сайте, чтобы избежать прохождения Captcha.

4. **JavaScript-решения**:
   - В некоторых случаях, используя более сложные скрипты и инструменты, можно обойти проверки, которые Cloudflare применяет через JavaScript. Однако это требует продвинутых знаний в области программирования и обхода защиты.


### Сервисы антикапчи

На сегодняшний день существует множество нейросетей для решения капчи различной сложности. Алгоритмы капчи и их решения постоянно меняются, некоторые улучшаются, а некоторые перестают быть популярными. Изучение нейросетей для наших целей видится мне очень трудо- и ресурсозатратным занятием.

Есть технологии, которые намного проще и быстрее, как для изучения, так и для применения. Вам не потребуется тратить несколько дней на обучение нейросети для решения капчи на определенном сайте. Написание кода для обхода капчи займет у вас в десятки, а то и сотни раз меньше времени, чем при работе с нейронными сетями, особенно если вы никогда с ними не работали.

**Все уже давно придумано за нас.** Сервисы анти-капчи точно так же справляются с этой задачей, как и 10-15 лет назад. Нам осталось найти секретный ключ капчи на сайте, где она появляется, и передать его в API сервиса для распознания капчи. В ответ мы получим другой, уже распознанный, ключ.

Существует множество сервисов по распознаванию капчи, но мы будем работать только с одним из них. Научившись работать с одним, вы сможете работать с любым другим.

**Важное примечание:** Все сервисы по разгадыванию капчи помогают обходить капчу на бэкенде, формируя распознанный ключ. Обход капчи на фронтенде т.е. непосредственно в браузере, делается с помощью Selenium и дополнительных библиотек, API, и нейросетей. Но все же, есть такие капчи, которые решаются на фронтенде с помощью сервисов.

1. RuCaptcha.com (https://rucaptcha.com?from=1562326) - наверное, самый популярный сервис для решения капчи в рунете. Именно им мы будем пользоваться по причине того, что он умеет работать с капчами от Yandex, которые используются в основном в рунете. Сервис привлекает для решения капчи реальных пользователей, которые решают наши капчи вручную и получают небольшое вознаграждение за это. Мы будем им за это платить. Тарифы вполне адекватные - до 50 рублей за 1000 обычных капч и до 160 рублей за 1000 сложных капч. Актуальный прайс можно посмотреть тут (https://rucaptcha.com/pricing).
На распознавание капчи может уходить от 5 до 30 секунд, в зависимости от ее сложности и загруженности сервиса.
2. 2Сaptcha.com (https://2captcha.com/) - клон рукапчи, но ориентирован на англоязычный сегмент. Могут возникать проблемы с Yandex капчей и пополнением баланса, если вы находитесь в России.
3. anti-captcha.com (https://anti-captcha.com/) - еще один относительно крупный сервис для решения капчи, также ориентирован на англоязычный сегмент. Из особенностей - распознавание JavaScript-капчи. По стоимости и времени разгадывания практически не отличается от других. Также могут возникнуть проблемы с Yandex-капчей и пополнением баланса, если вы в РФ.

**Итак, подведём итоги:**
- Каждый сервис привлекает реальных пользователей для решения капчи;
- Стоимость решения везде одинакова;
- Скорость решения также везде одинакова;
- Какой-то сервис может быть загружен, а какой нет, это влияет на скорость решения капчи. Также скорость решения зависит от количества пользователей, которые решают капчу;
Обход капчи стоит очень дешево.

### Плюсы и минусы сервисов антикапчи

**Плюсы:**
- Высокая скорость написания кода, можно уложиться в одну функцию; 
- Низкая цена на решения капчи;
- Простота использования API сервиса, очень подробная документация (https://rucaptcha.com/api-rucaptcha#solving_captchas);
- Один сервис может решить практически любые виды капч, в отличие от нейросетей;
Сервисы устойчивы к изменению алгоритма капч, они сами подстраивают свою работу, иногда вы даже не заметите, что капча изменила свой алгоритм.

**Минусы:**
- Нужно следить, чтобы баланс всегда был положительным (если вы пишете парсер на заказ, то можно делегировать этот пункт заказчику); 
- Скорость решения капчи (от 5 до 20 секунд, ваш парсер ничего не будет делать, а только ждать ответа с ключом); 
- Ошибки в решении, иногда пользователи могут решить капчу неправильно и прислать нам неверный результат, в таком случае мы отправляем ключ капчи снова. Неверные решения можно не оплачивать, отправив в ответ определённый параметр.

### Решение распознаванием речи
Один из способ решить капчу - это использовать аудиофайл капчи. Он создан для слабовидящих людей и является хорошей альтернативой для ее обхода. Для появления интерфейса с аудиофрагментом необходимо кликнуть на иконку с наушниками, после чего появится нужный интерфейс.

![alt text](image-5.png)  
![alt text](image-6.png)

Шанс распознавания текста в аудио очень высокий, но несмотря на такой высокий процент, Google будет вставлять нам палки в колеса еще до того, как мы доберемся до аудио интерфейса. Решая капчу этим способом, вы будете получать подобные уведомления (изображение ниже). Это довольно не приятно, но вполне решаемо.

![alt text](image-7.png)